<h1>Context: another covid-19 story...</h1>
<p>At home I have a limited 4G connection (100GB/month). 
It is working pretty good. (download=20Mbps , upload=20Mbps).
So it is very easy to burn ! 12hours at full speed and then you have to wait for the next month... </p>
<p>In addition, when working at home (Covid situation) It is just not possible to take a skype call when wife or kids are on netflix ! (the bandwidth should be enough but it is obviously not even distributed)</p>
<p>My router is very basic and do not make possible to limt the bandwidth per user.
So I took a old raspberrypi and create an wifi access point (using hostapd / isc-dhcp-server) 
then comes wondershaper which is great to limit the bandwidth 
but i pushed further to limit the bandwidth per user and not only globally.</p>
<p>I did not bother to make a configurable script. All is harcodded. So for information this is my setting :</p>
<ul>
<li>
<p>raspberrypi is connected to my internet routeur with eth0 (192.167.7.x)</p>
</li>
<li>
<p>raspberrypi access point is on wlan0 <br>192.167.10.1 is the ip of the pi, and dhcp distribute addresse fom 192.167.10.10 to 192.167.10.19</p>
</li>
</ul>
<h1>Analysis of a typical wondershaper command</h1>
<h2>reference command</h2>
<p>Result of:</p>
<pre><code>./wondershaper_echo -a myinterface -d 1000 -u 500
</code></pre>
<p>would be:</p>
<pre><code>tc qdisc add dev myinterface root handle 1: htb default 20
tc class add dev myinterface parent 1: classid 1:1 htb rate 500kbit prio 5
tc class add dev myinterface parent 1:1 classid 1:10 htb rate 100kbit ceil 475kbit prio 1
tc class add dev myinterface parent 1:1 classid 1:20 htb rate 200kbit ceil 475kbit prio 2
tc class add dev myinterface parent 1:1 classid 1:30 htb rate 100kbit ceil 450kbit prio 3
tc qdisc add dev myinterface parent 1:10 handle 10: sfq perturb 10 quantum 6000
tc qdisc add dev myinterface parent 1:20 handle 20: sfq perturb 10 quantum 6000
tc qdisc add dev myinterface parent 1:30 handle 30: sfq perturb 10 quantum 6000
tc filter add dev myinterface parent 1: protocol ip prio 10 u32 match ip tos 0x10 0xff flowid 1:10
tc filter add dev myinterface parent 1: protocol ip prio 11 u32 match ip protocol 1 0xff flowid 1:10
tc filter add dev myinterface parent 1: protocol ip prio 12 u32 match ip protocol 6 0xff match u8 0x05 0x0f at 0 match u16 0x0000 0xffc0 at 2 flowid 1:10
# below is few command not generated by default (it would allow to select flow(1:30) by port or ipaddress
# mask=0xffff means a full match of the ip/port 0xfff0 would filter based oin only the 24bit of the ip 
#tc filter add dev "$IFACE" parent 1: protocol ip prio 14 u32 match ip dport "$dport" 0xffff flowid 1:30;
#tc filter add dev "$IFACE" parent 1: protocol ip prio 15 u32 match ip sport "$sport" 0xffff flowid 1:30;
#tc filter add dev "$IFACE" parent 1: protocol ip prio 16 u32 match ip src   "$src"   0xffff flowid 1:30;
#tc filter add dev "$IFACE" parent 1: protocol ip prio 17 u32 match ip dst   "$dst"   0xffff flowid 1:30;
tc filter add dev myinterface parent 1: protocol ip prio 18 u32 match ip dst 0.0.0.0/0 flowid 1:20
</code></pre>
<h2>few explaination</h2>
<p>tc manual <a href="https://linux.die.net/man/8/tc">here</a></p>
<p>qdisc = "Queuing Disciplines"</p>
<p><a href="https://www.man7.org/linux/man-pages/man8/tc-htb.8.html">HTB</a> = "Hierarchy Token Bucket"</p>
<ul>
<li>"default 20" indicate the default class if no further filter matches</li>
</ul>
<p><a href="https://www.man7.org/linux/man-pages/man8/tc-sfq.8.html">sfq</a> = Stochastic Fairness Queueing. is Maybe the most "fair" to arbitrate simulanous flow</p>
<ul>
<li>
<p>perturb 10 = Interval in seconds for queue algorithm perturbation. ie. It "reorganizes" arbitration every 10s.</p>
</li>
<li>
<p>quantum 6000 = allow to deque 6kB for each flow per round-robin round.</p>
</li>
</ul>
<p>For protocol cf <a href="https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers">wikipedia/List_of_IP_protocol_numbers</a></p>
<ul>
<li>
<p>protocol1=ICMP</p>
</li>
<li>
<p>protocol6=TCP</p>
</li>
<li>
<p><a href="http://www.bogpeople.com/networking/dscp.shtml">tos</a> 0x10 0xff, filter Type Of Service. (low delay: see the yellow one)</p>
</li>
</ul>
<hr />
<h2>below is the Orignal ReadMe from magnific0/wondershaper:</h2>
<h1>The Wonder Shaper 1.4.1</h1>
<h2>Copyright</h2>
<p>Copyright (c) 2002-2020 Bert Hubert <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#97;&#104;&#117;&#64;&#100;&#115;&#57;&#97;&#46;&#110;&#108;">&#97;&#104;&#117;&#64;&#100;&#115;&#57;&#97;&#46;&#110;&#108;</a>, Jacco Geul <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#106;&#97;&#99;&#99;&#111;&#64;&#103;&#101;&#117;&#108;&#46;&#110;&#101;&#116;">&#106;&#97;&#99;&#99;&#111;&#64;&#103;&#101;&#117;&#108;&#46;&#110;&#101;&#116;</a>, Simon Séhier <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#115;&#105;&#109;&#111;&#110;&#64;&#115;&#101;&#104;&#105;&#101;&#114;&#46;&#102;&#114;">&#115;&#105;&#109;&#111;&#110;&#64;&#115;&#101;&#104;&#105;&#101;&#114;&#46;&#102;&#114;</a>, <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#99;&#111;&#114;&#98;&#111;&#108;&#97;&#105;&#115;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;">&#99;&#111;&#114;&#98;&#111;&#108;&#97;&#105;&#115;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;</a></p>
<p>See the ChangeLog for information on the individual contributions of the authors.</p>
<h2>About</h2>
<p>Wonder Shaper is a script that allows the user to limit the bandwidth of one or more network adapters. It does so by using iproute's tc command, but greatly simplifies its operation. Wonder Shaper was first released by Bert Hubert in 2002, but the original version lacked a command-line interface, from on version 1.2 this feature was added. From version 1.3, the HTB queuing is used instead of CBQ, allowing better bandwidth management on high speed (above ten megabits) links. In version 1.4 an improved ingress shaping method was implemented and the ability to limit either down or up (both is still possible too). The original README is a rather lengthy document and is saved under README.old, for those who'd like some more background information. Except any notes on operation this document is considered up-to-date.</p>
<h2>Installation</h2>
<h3>Obtaining wondershaper</h3>
<p>It is recommended to clone the GitHub repository of wondershaper such that you can pull in new updates at any time (if available). Open a new terminal and clone the repository using</p>
<pre><code>git clone https://github.com/magnific0/wondershaper.git
</code></pre>
<p>This will clone wondershaper in your current folder in a new folder named wondershaper. Now enter the folder using</p>
<pre><code>cd wondershaper
</code></pre>
<h3>Using wondershaper</h3>
<p>You can run wondershaper (as any user with sufficient permissions) without installation and stop following the instructions at this point. Show the wondershaper usage instructions by typing</p>
<pre><code>./wondershaper -h
</code></pre>
<p>The program details all available options on how to use wondershaper. Next is to pick an interface that you want to shape. You can see all available interfaces by typing</p>
<pre><code>ip addr show
</code></pre>
<p>Note that on older systems this command might not be available. In this case you should run <code>ifconfig</code> instead.</p>
<p>Identify the network interface that you want to shape. The names <a href="https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/">differ per system</a>.</p>
<p>In the following example a wireless interface is limited to an <a href="http://whatsabyte.com/">upload of 4Mbps and download of 8Mbps</a>.</p>
<pre><code>./wondershaper -a wlp4s0 -u 4096 -d 8192
</code></pre>
<p>If you get messages telling you that <code>RTNETLINK answers: Operation not permitted</code> your user account does not have sufficient privileges. In that case try:</p>
<pre><code>sudo ./wondershaper -a wlp4s0 -u 4096 -d 8192
</code></pre>
<h3>System installation (optional)</h3>
<p>A makefile file provided for easy installation. The default location for wondershaper is in <code>/usr/bin</code>. If you want to install to your system you can run:</p>
<pre><code>sudo make install
</code></pre>
<p>You can verify that wondershaper was installed correctly by entering:</p>
<pre><code>which wondershaper
</code></pre>
<p>This should return <code>/usr/bin/wondershaper</code>. You can follow the same instructions as explained in the "Using wondershaper" section, but instead of running the local version of the program you now run the system version by removing the <code>./</code> from the beginning of each command. For example to show the help instructions again run:</p>
<pre><code>wondershaper -h
</code></pre>
<h3>Persistent usage of wondershaper (optional)</h3>
<p>Instead of using the commandline options to set the rates and interface as previously shown, it is necessary to set these parameters in the <code>wondershaper.conf</code> configuration file. You can edit this file using your favourite text editor (vim in the example below) as such:</p>
<pre><code>sudo vim /etc/systemd/wondershaper.conf
</code></pre>
<p>To make sure wondershaper is reactivated on reboot a systemd service file is provided. First enable wondershaper as a systemd service using:</p>
<pre><code>sudo systemctl enable --now wondershaper.service
</code></pre>
<p>This way wondershaper is activated with your setting upon reboot.</p>
<h2>Usage</h2>
<pre><code>    wondershaper [-hcs] [-a &lt;adapter&gt;] [-d &lt;rate&gt;] [-u &lt;rate&gt;]
</code></pre>
<p>The following command line options are allowed:</p>
<ul>
<li>
<p><code>-h</code> Display help</p>
</li>
<li>
<p><code>-a &lt;adapter&gt;</code> Set the adapter</p>
</li>
<li>
<p><code>-d &lt;rate&gt;</code> Set maximum download rate (in Kbps) and/or</p>
</li>
<li>
<p><code>-u &lt;rate&gt;</code> Set maximum upload rate (in Kbps)</p>
</li>
<li>
<p><code>-p</code> Use the presets in /etc/systemd/wondershaper.conf</p>
</li>
<li>
<p><code>-c</code> Clear the limits from adapter</p>
</li>
<li>
<p><code>-s</code> Show the current status of adapter</p>
</li>
</ul>
<p>The different modes are:</p>
<pre><code>    wondershaper -a &lt;adapter&gt; -d &lt;rate&gt; -u &lt;rate&gt;

    wondershaper -c -a &lt;adapter&gt;

    wondershaper -s -a &lt;adapter&gt;
</code></pre>
<p>Some examples:</p>
<pre><code>    wondershaper -a eth0 -d 1024 -u 512

    wondershaper -a eth1 -d 94000 -u 94000  # could be used on a 100Mbps link

    wondershaper -a eth1 -u 94000  # only limit upload

    wondershaper -c -a eth0
</code></pre>
<p>dimanche, 07. février 2021 03:13 </p>
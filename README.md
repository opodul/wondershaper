#Context: another covid-19 story...
At home I have a limited 4G connection (100GB/month). 
It is usually working pretty good. (download=20Mbps , upload=20Mbps).
So it is very easy to burn ! 12hours at full speed and then you have to wait for the next month... 

In addition, when working at home (Covid situation) It is just not possible to take a skype call when wife or kids are on netflix ! (the bandwidth should be enough but it is obviously not even distributed)

BTW, I discovered that netflix automatically adapt to the bandwidth, hight bandwidth = high resolution ... even if your small screen is not able to display it ! 
There is some setting possible on the account but the effect are very limited.
Also, when you stop to watch netflix on android device, it is still downloading in background !


My router is very basic and do not make possible to limit the bandwidth per user.
So I took a old raspberrypi and created an wifi access point (using hostapd and isc-dhcp-server) 
then comes wondershaper which is great to limit the bandwidth globally.
but i pushed further to limit the bandwidth per user.

I did not bother to make a configurable script. All is harcodded. So for information this is my setting :

- raspberrypi is connected to my internet routeur with eth0

- raspberrypi access point is on wlan0 <br>192.167.10.1 is the ip of the pi, and dhcp distribute address from 192.167.10.10 to 192.167.10.19<br>
192.167.10.10 = mine --> using class 1:10  <br>
192.167.10.11 = wife_device1 --> using class 1:20 <br>
192.167.10.12 = wife_device2 --> using class 1:20 <br>
192.167.10.13+ considered for not priority users. --> using class 1:30

filter are based on ip addr, it could probably be done based on MAC but I did not investigated further.

One important thing to understand is that which tc you can only control the speed of the packet you send (upload).
It is actually exactly that we want as the raspberrypi is sending to device data. So upload for raspberry is actually download for the wifi connected devices.


That being said, if you check the last lines of wondershaper, you will see the trick for download: incoming paquets are redirected to a virtual interface and then the outgoing speed of the virtual interface is limited. As a result when the fifo of the virtual channel is full, any additionnal incoming paquet will be lost and therefore the server/client will addapt and lower the speed... 
not very pretty but it works.

mywondershaper only limit wlan0 rasberry upload.

An alternative would be to use iptable with hashlimit module. It would have the benefit to tarquet only small paquet (SYNC-handskake), therefore it would be a little bit more efficient as no "big" paquet would be dropped.


#Analysis of a typical wondershaper command
##reference command

Result of:

    ./wondershaper_echo -a myinterface -d 1000 -u 500

would be:

    tc qdisc add dev myinterface root handle 1: htb default 20
    tc class add dev myinterface parent 1: classid 1:1 htb rate 500kbit prio 5
    tc class add dev myinterface parent 1:1 classid 1:10 htb rate 100kbit ceil 475kbit prio 1
    tc class add dev myinterface parent 1:1 classid 1:20 htb rate 200kbit ceil 475kbit prio 2
    tc class add dev myinterface parent 1:1 classid 1:30 htb rate 100kbit ceil 450kbit prio 3
    tc qdisc add dev myinterface parent 1:10 handle 10: sfq perturb 10 quantum 6000
    tc qdisc add dev myinterface parent 1:20 handle 20: sfq perturb 10 quantum 6000
    tc qdisc add dev myinterface parent 1:30 handle 30: sfq perturb 10 quantum 6000
    tc filter add dev myinterface parent 1: protocol ip prio 10 u32 match ip tos 0x10 0xff flowid 1:10
    tc filter add dev myinterface parent 1: protocol ip prio 11 u32 match ip protocol 1 0xff flowid 1:10
    tc filter add dev myinterface parent 1: protocol ip prio 12 u32 match ip protocol 6 0xff match u8 0x05 0x0f at 0 match u16 0x0000 0xffc0 at 2 flowid 1:10
    # below is few command not generated by default (it would allow to select flow(1:30) by port or ipaddress
    # mask=0xffff means a full match of the ip/port 0xfff0 would filter based oin only the 24bit of the ip 
    #tc filter add dev "$IFACE" parent 1: protocol ip prio 14 u32 match ip dport "$dport" 0xffff flowid 1:30;
    #tc filter add dev "$IFACE" parent 1: protocol ip prio 15 u32 match ip sport "$sport" 0xffff flowid 1:30;
    #tc filter add dev "$IFACE" parent 1: protocol ip prio 16 u32 match ip src   "$src"   0xffff flowid 1:30;
    #tc filter add dev "$IFACE" parent 1: protocol ip prio 17 u32 match ip dst   "$dst"   0xffff flowid 1:30;
    tc filter add dev myinterface parent 1: protocol ip prio 18 u32 match ip dst 0.0.0.0/0 flowid 1:20
    
##few explaination
    
tc manual [here](https://linux.die.net/man/8/tc)

qdisc = "Queuing Disciplines"

[HTB](https://www.man7.org/linux/man-pages/man8/tc-htb.8.html) = "Hierarchy Token Bucket"

- "default 20" indicate the default class if no further filter matches

- [difference-between-htb-rate-and-ceil-values](https://serverfault.com/questions/389328/difference-between-htb-rate-and-ceil-values)

[sfq](https://www.man7.org/linux/man-pages/man8/tc-sfq.8.html) = Stochastic Fairness Queueing. is Maybe the most "fair" to arbitrate simulanous flow

- perturb 10 = Interval in seconds for queue algorithm perturbation. ie. It "reorganizes" arbitration every 10s.

- quantum 6000 = allow to deque 6kB for each flow per round-robin round.
    
For protocol cf [wikipedia/List_of_IP_protocol_numbers](https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers)

- protocol1=ICMP

- protocol6=TCP

- [tos](http://www.bogpeople.com/networking/dscp.shtml) 0x10 0xff, filter Type Of Service. (low delay: see the yellow one)


-----------------------------------------------------------
below is the Orignal ReadMe from magnific0/wondershaper:
-----------------------------------------------------------
The Wonder Shaper 1.4.1
==============

Copyright
-------------

Copyright (c) 2002-2020 Bert Hubert <ahu@ds9a.nl>, Jacco Geul <jacco@geul.net>, Simon Séhier <simon@sehier.fr>, <corbolais@gmail.com>

See the ChangeLog for information on the individual contributions of the authors.

About
--------------

Wonder Shaper is a script that allows the user to limit the bandwidth of one or more network adapters. It does so by using iproute's tc command, but greatly simplifies its operation. Wonder Shaper was first released by Bert Hubert in 2002, but the original version lacked a command-line interface, from on version 1.2 this feature was added. From version 1.3, the HTB queuing is used instead of CBQ, allowing better bandwidth management on high speed (above ten megabits) links. In version 1.4 an improved ingress shaping method was implemented and the ability to limit either down or up (both is still possible too). The original README is a rather lengthy document and is saved under README.old, for those who'd like some more background information. Except any notes on operation this document is considered up-to-date.

Installation
--------------

### Obtaining wondershaper

It is recommended to clone the GitHub repository of wondershaper such that you can pull in new updates at any time (if available). Open a new terminal and clone the repository using

    git clone https://github.com/magnific0/wondershaper.git

This will clone wondershaper in your current folder in a new folder named wondershaper. Now enter the folder using

    cd wondershaper

### Using wondershaper

You can run wondershaper (as any user with sufficient permissions) without installation and stop following the instructions at this point. Show the wondershaper usage instructions by typing

    ./wondershaper -h

The program details all available options on how to use wondershaper. Next is to pick an interface that you want to shape. You can see all available interfaces by typing

    ip addr show

Note that on older systems this command might not be available. In this case you should run ```ifconfig``` instead.

Identify the network interface that you want to shape. The names [differ per system](https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/).

In the following example a wireless interface is limited to an [upload of 4Mbps and download of 8Mbps](http://whatsabyte.com/).

    ./wondershaper -a wlp4s0 -u 4096 -d 8192

If you get messages telling you that ```RTNETLINK answers: Operation not permitted``` your user account does not have sufficient privileges. In that case try:

    sudo ./wondershaper -a wlp4s0 -u 4096 -d 8192

### System installation (optional)

A makefile file provided for easy installation. The default location for wondershaper is in ```/usr/bin```. If you want to install to your system you can run:

    sudo make install

You can verify that wondershaper was installed correctly by entering:

    which wondershaper

This should return ```/usr/bin/wondershaper```. You can follow the same instructions as explained in the "Using wondershaper" section, but instead of running the local version of the program you now run the system version by removing the ```./``` from the beginning of each command. For example to show the help instructions again run:

    wondershaper -h

### Persistent usage of wondershaper (optional)


Instead of using the commandline options to set the rates and interface as previously shown, it is necessary to set these parameters in the ```wondershaper.conf``` configuration file. You can edit this file using your favourite text editor (vim in the example below) as such:

    sudo vim /etc/systemd/wondershaper.conf

To make sure wondershaper is reactivated on reboot a systemd service file is provided. First enable wondershaper as a systemd service using:

    sudo systemctl enable --now wondershaper.service

This way wondershaper is activated with your setting upon reboot.

Usage
--------------

        wondershaper [-hcs] [-a <adapter>] [-d <rate>] [-u <rate>]

The following command line options are allowed:

- `-h` Display help

- `-a <adapter>` Set the adapter

- `-d <rate>` Set maximum download rate (in Kbps) and/or

- `-u <rate>` Set maximum upload rate (in Kbps)

- `-p` Use the presets in /etc/systemd/wondershaper.conf

- `-c` Clear the limits from adapter

- `-s` Show the current status of adapter

The different modes are:

        wondershaper -a <adapter> -d <rate> -u <rate>
    
        wondershaper -c -a <adapter>
    
        wondershaper -s -a <adapter>

Some examples:

        wondershaper -a eth0 -d 1024 -u 512
    
        wondershaper -a eth1 -d 94000 -u 94000  # could be used on a 100Mbps link
    
        wondershaper -a eth1 -u 94000  # only limit upload
    
        wondershaper -c -a eth0
dimanche, 07. février 2021 03:13 
